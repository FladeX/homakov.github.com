<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
   <head>
      <title>Map with valid credentials</title>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
      <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
      <script type="text/javascript">
      var map = null;
      var idz = {};
      var fetched = {};
            
      </script>
   </head>
   <body onload="">
<a style="position:absolute; top:0px;right:0px;z-index:1000" href="#" onclick="return bookmaper.add('eg');"><img src='b.gif'></a>
<div style="position:absolute; top:42px;right:0px;z-index:1000; width:42px;" id="bookmaper">
<a style="width: 0;	height: 0;	border-top: 25px solid transparent;	border-left: 42px solid red;	border-bottom: 25px solid transparent;display:block;float:left;" onclick="return bookmaper.play()"></a>
</div>
      <div id='myMap' style="width:100%; height:100%;"></div>
   </body>
   <script>
   if (!Function.prototype.bind) {

  Function.prototype.bind = function (oThis) {

    if (typeof this !== "function") // closest thing possible to the ECMAScript 5 internal IsCallable function
      throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");

    var aArgs = Array.prototype.slice.call(arguments, 1), 
        fToBind = this, 
        fNOP = function () {},
        fBound = function () {
          return fToBind.apply(this instanceof fNOP ? this : oThis || window, aArgs.concat(Array.prototype.slice.call(arguments)));    
        };

    fNOP.prototype = this.prototype;
    fBound.prototype = new fNOP();

    return fBound;

  };

}

function insertPipeLL(fetch){
  if(fetched[fetch]){
  return true;
  }else{
  fetched[fetch]=true;
}

var CLIENT='MWVNMLYPIQHDN4GK4HDXA42GDQ44TBPCOUOCNA2C0CSKJ0OS';
var SECRET='DGP4QFXQ4N4NOZAKJXQOV4DZCCFKG2IYA3EOYUDDOATPW5DG';

queueFun="https://api.foursquare.com/v2/venues/search?ll="+fetch+"&limit=100&radius=1000&v=20110912&client_id="+CLIENT+"&client_secret="+SECRET+"&callback=insertItems";
}


function insertPipe(url){
if(url){
  var fileref=document.createElement('script')
  fileref.setAttribute("type","text/javascript")
  fileref.setAttribute("src", url)
  document.getElementsByTagName("head")[0].appendChild(fileref)
  return true;
}
}
   
   
   function insertItems(e){
     
     e.response.venues.forEach(function(v,k){
           if(idz[v.id])
           return true;
           idz[v.id]=v;
           var opts ={};
           var offset = new Microsoft.Maps.Point(0, 5); 
           opts.text = v.stats.checkinsCount.toString();
           //opts.visible = true;
           opts.textOffset = offset; 
           if(v.categories.length>0){
             opts.icon = v.categories[0].icon;
             opts.width = 32;
             opts.height = 32;
             opts.text = null;
           }           
           var pushpin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(v.location.lat,v.location.lng), opts); 
          var pin= Microsoft.Maps.Events.addHandler(pushpin, 'click', (function(id,pushpin){
          var obj = idz[id];
 var infoboxOptions = {title:obj.name, 
 description: obj.location.address+"\n checkins: "+obj.stats.checkinsCount+"\n now: "+obj.hereNow.count+"\nUsers now:"+obj.stats.usersCount+"\n Id: "+obj.id }; 
 var defaultInfobox = new Microsoft.Maps.Infobox(pushpin.getLocation(), infoboxOptions);    
 map.entities.push(defaultInfobox);
          }).bind(this,v.id,pushpin));  
map.entities.push(pushpin);   
     });
     
   }
   
   
  var fixit = function(x,step){
    return Number((x).toFixed(6));
    return step*Math.floor(x/step)
  }
   var queueFun = function(){};
          var map = new Microsoft.Maps.Map(document.getElementById('myMap'), {credentials: 'Am7S0kGnrrLmRnMOp3HBkkmpyMVlsIYOZwUlDY5LHjHC0jyz5nIP5OHDnKT4QHqx'
          });
          
        var geoLocationProvider = new Microsoft.Maps.GeoLocationProvider(map);  
       
       geoLocationProvider.getCurrentPosition();
// center: new Microsoft.Maps.Location(47.609771, -122.2321543125), zoom: 8});
var NLat, NLng

          Microsoft.Maps.Events.addHandler(map, 'viewchangeend', function(){
            var zoom = map.getZoom();
            var bounds = map.getBounds();
            console.log(zoom);
            if(zoom>12){
              var lat = (bounds.center.latitude.toString().match(/-?\d+\.\d{5}/));
              var lng = (bounds.center.longitude.toString().match(/-?\d+\.\d{5}/));
              Nlat = Number(lat);
              Nlng = Number(lng);
              insertPipeLL(Nlat+','+Nlng);
             
             /*
              sign=1;
              step = 0.01
              for(var bndRnd = 0; bndRnd<5;bndRnd++){
                for(var x1 = 1; x1<bndRnd;x1++){
                Nlat=fixit(Nlat+step*sign);
                console.log(Nlat,Nlng);
                insertPipeLL(Nlat+','+Nlng);
                }
                for(var x2 = 1; x2<bndRnd;x2++){
                Nlng=fixit(Nlng+step*sign);
                console.log(Nlat,Nlng);
                insertPipeLL(Nlat+','+Nlng);
                }
                sign=-sign;
              }
           */
            }
            
            
          });
      
      
      setInterval(function(){
      insertPipe(queueFun);
      queueFun = null;
      },500);
      
      
      var spots = [];           
  var bookmaper = {spots:spots,map:map,colours:['aqua', 'black', 'blue', 'fuchsia', 'gray', 'green', 'lime', 'maroon', 'navy', 'olive', 'purple', 'red', 'silver', 'teal', 'white','yellow'],delay:2500};
  bookmaper.play = function(){
    for(var i = 0, l=this.spots.length;i<l;i++){
      setTimeout( (function(i){
      /*if(i>this.spots.length){
        i=i%this.spots.length;
      }*/
      this.goto(i);
      }).bind(this,i) ,this.delay*(i));
    }
  }
  
  bookmaper.insert = function(obj){
    document.getElementById("bookmaper").innerHTML+='<a href="#" style="width: 42px;height: 42px;background:'+obj.color+';display:block;float:left;" onclick="return bookmaper.goto('+obj.key+');"></a>';
  
  }
  
  bookmaper.add = function(title){
    var color = this.colours.pop();
    var obj = {
      zoom: this.map.getZoom(),
      latitude: this.map.getCenter().latitude,
      longitude: this.map.getCenter().longitude,
      title: title,
      color: color
    }
    var key = this.spots.push(obj)-1;
    obj.key=key;
   this.insert(obj);
    document.location.hash = 'spots='+encodeURI(JSON.stringify(this.spots))
   return false;
  }
  bookmaper.goto = function(key){
    var spot = this.spots[key];
    var ll = this.map.getCenter();
    var distance = Math.sqrt(Math.pow(spot.longitude-ll.longitude,2)+Math.pow(spot.latitude-ll.latitude,2));
    console.log(distance);

    this.map.setView({ zoom: spot.zoom, center: new Microsoft.Maps.Location(spot.latitude, spot.longitude) })  
    return false;
  }
  var hash = document.location.hash.split('spots=')[1];
  if(hash){
    
    bookmaper.spots = JSON.parse(decodeURI(hash));
    
    bookmaper.spots.forEach(function(v,k){
        v.key = k;
      bookmaper.insert(v);
    })
  }
  
      
//      bing.maps.bookmark.js
      
   </script>
</html>
      
